language: java
notifications:
  slack:
    secure: FIHlTn/YO7Wgumm1uIqmoEsqjQA7fV0AE94Rjc5yKzM3AquQa8HicgDVVk0d2GrKRnl0xt3j4ZJV//VJyIjlCd/QVKuj48R2ChjEY2im3+99HFPafCUI5/S2uyowKU6mJTFonH9v6p41eqxdbiAxJdDGOT0V2Gpt3UBSNuHz8ED9/aIHqv+P7M+VD6Xd2XYwctPniWlaSWx57sWcnG/VkFG45qFQAyha64uxOOe4M3ZmG/n5FfauZ8cBVLiRKEIr+CyNhh1ujfzi7+4uzMlSNL5t/BbZamAQuZzqGzGQ9RVvIlyPgUGNJtDEE/hWS09aagXF5T6EMj00szizErh4J1/x4qZwml5+TcBN31E0QmAhCtZe85sr3tYgic+hEz9XX1yymQzf/C7n4to2yNvq0r4g51xDk8IuP95WEh7zaqLlvFZvBFgxpHZBMYlRvhytjOYDeIFRMcGwHZcXosaG2ejqDwcGq/LC4oeG4sSwmg9sdRrtcmcanrNqrBka86WYO6LntI3JdZ86/1ACEUHzhCCwvrKELc9Ji1xxGAgS7QKH+s2/hnJuiMyv73gOVLKYC+wPMLt+fvOmPLSEl+PJiAIlToBq1KUBg03RSQLfPOLD7OrJ8VvDZsEPwejqlGDyc4wRglS9OTi7SnN5LYHSDNDdGdREegWqq9qDHEYEVLI=
branches:
  only:
  - development
dist: trusty
sudo: required
env:
  matrix:
    - ENGINE=lucee@4.5 BOX=lucee CONFIG_FOLDER=lucee
    - ENGINE=lucee@5 BOX=lucee CONFIG_FOLDER=lucee
    - ENGINE=lucee@5 BOX=lucee CONFIG_FOLDER=lucee-fullnull
    - ENGINE=adobe@2016 BOX=adobe CONFIG_FOLDER=lucee
    - ENGINE=adobe@11 BOX=adobe CONFIG_FOLDER=lucee
    - ENGINE=adobe@10 BOX=adobe CONFIG_FOLDER=lucee
addons:
  apt:
    packages:
    - mysql-server-5.6
    - mysql-client-core-5.6
    - mysql-client-5.6
before_install:
# Temporarily use the staging version of CommandBox for multi-engine support
- mkdir /tmp/bin
- export PATH=$PATH:/tmp/bin

# Bring these lines back when CommandBox 3.1.0 is released.
# - sudo apt-key adv --keyserver keys.gnupg.net --recv 6DA70622
# - sudo echo "deb http://downloads.ortussolutions.com/debs/noarch /" | sudo tee -a
#   /etc/apt/sources.list.d/commandbox.list
install:
# Temporarily use the staging version of CommandBox for multi-engine support
- curl --location 'http://integration.stg.ortussolutions.com/artifacts/ortussolutions/commandbox/3.1.0/commandbox-bin-3.1.0.zip' -o /tmp/box.zip
- unzip /tmp/box.zip -d /tmp/bin

# Bring this line back when CommandBox 3.1.0 is released.
# - sudo apt-get update && sudo apt-get --assume-yes install commandbox

# startup server so we can get directory location first
- box install
- box server start cfengine=$ENGINE
- box server stop
# Copy over special settings for testing
- box recipe build/setup-$BOX-standalone.box $CONFIG_FOLDER
before_script:
# create test database
- mysql -u root -e 'create database coolblog;'
# import database
- mysql -u root < tests/resources/coolblog.sql
# Ready for testing
- box server start cfengine=$ENGINE
script: >
  testResults="$(box testbox run runner='http://localhost:8599/tests/runner.cfm' )";
  echo "$testResults";
  if grep -i "\[(Failures|Errors): [1-9][0-9]\?[0-9]\?\]\|\[Errors: [1-9][0-9]\?[0-9]\?\]\|<t[^>]*>\|<b[^>]*>" <<< $testResults;  then exit 1; fi